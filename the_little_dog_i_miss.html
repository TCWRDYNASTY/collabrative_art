<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>The Little Dog I Miss</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<div id="introOverlay">
    <p>The art here is a collaborative puzzle. Find the hidden pieces to reveal the story of "The Little Dog I Miss."</p>
    <button id="viewartBtn">View the Art</button>
</div>

<div class="frame-wrapper">
    <div class="puzzle-grid" id="main-puzzle">
        <div id="piece-1" class="piece"><img src="section1.png"><div class="label-id">?</div></div>
        <div id="piece-2" class="piece"><img src="section2.png"><div class="label-id">?</div></div>
        <div id="piece-3" class="piece"><img src="section3.png"><div class="label-id">?</div></div>
        <div id="piece-4" class="piece"><img src="section4.png"><div class="label-id">?</div></div>
        <div id="piece-5" class="piece"><img src="section5.png"><div class="label-id">?</div></div>
        <div id="piece-6" class="piece"><img src="section6.png"><div class="label-id">?</div></div>
        <div id="piece-7" class="piece"><img src="section7.png"><div class="label-id">?</div></div>
        <div id="piece-8" class="piece"><img src="section8.png"><div class="label-id">?</div></div>
        <div id="piece-9" class="piece"><img src="section9.png"><div class="label-id">?</div></div>
    </div>
</div>

<div class="container">
    <h1>The Little Dog I Miss</h1>
    <h2 id="status-display">Digital Media</h2>
</div>
        
   <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
// --- CONFIGURATION ---
const REVEAL_DATE = new Date(2026, 11, 31, 23, 59);

const firebaseConfig = {
  apiKey: "AIzaSyBakPBYb0ngjOvHr89baflUet6S4d6E7Ec",
  authDomain: "called0collaborative-art.firebaseapp.com",
  projectId: "called0collaborative-art",
  storageBucket: "called0collaborative-art.firebasestorage.app",
  messagingSenderId: "63650107916",
  appId: "1:63650107916:web:c0d369519d84d21d759429",
  measurementId: "G-8GLRF54W15"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- INITIALIZATION ---

// Combined listener to hide overlay and start the logic
document.getElementById('viewartBtn')?.addEventListener('click', () => {
    document.getElementById('introOverlay').classList.add('hidden');
    init(); // Only run the puzzle logic AFTER they click the button
});

async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const pieceNum = urlParams.get('piece'); 
    const project = urlParams.get('project') || 'penny'; 

    // 1. Check if the project is finished by date
    if (new Date() > REVEAL_DATE) {
        revealAll();
    } else {
        // 2. Load all currently found pieces from the database
        await loadFoundPieces(project);
    }

    // 3. Handle a new scan if 'piece' is in the URL
    if (pieceNum) {
        handleScannedPiece(pieceNum, project);
    }
}

// --- CORE LOGIC ---

async function loadFoundPieces(project) {
    const snapshot = await db.collection("puzzles")
        .where("project_id", "==", project)
        .where("is_found", "==", true)
        .get();

    snapshot.forEach(doc => {
        const idParts = doc.id.split('-');
        const num = idParts[idParts.length - 1];
        unlockPiece(num, false);
    });
}

async function handleScannedPiece(num, project) {
    const docId = `${project}-${num}`; 
    const docRef = db.collection("puzzles").doc(docId);

    try {
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();
            if (!data.is_found) {
                // UPDATE FIREBASE
                await docRef.update({
                    is_found: true,
                    found_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                unlockPiece(num, true);
            } else {
                unlockPiece(num, false);
            }
        }
        
        // CLEAN THE URL: This stops the "Auto-Unlock" loop on refresh
        // It removes "?piece=X" from the address bar without reloading the page
        window.history.replaceState({}, document.title, window.location.pathname);

    } catch (e) {
        console.error("Firebase Sync Error:", e);
    }
}

function unlockPiece(num, isFirst) {
    if (isFirst) {
        document.querySelector('h2').innerText = "CalleDÅ: Piece Discovered!";
    }
    const pieceElement = document.getElementById(`piece-${num}`);
    if (pieceElement) {
        pieceElement.classList.add('unlocked');
    }
}

function revealAll() {
    document.querySelectorAll('.piece').forEach(p => p.classList.add('unlocked'));
    document.querySelector('h2').innerText = "The hunt has concluded. Art revealed.";
}
     function handleFlip(el) {
    // Only allow the 3D flip if the piece has the 'unlocked' class
    if (el.classList.contains('unlocked')) {
        el.classList.toggle('flipped');
    } else {
        // Optional: a little nudge for the user
        console.log("This piece hasn't been discovered yet!");
    }
}
    
</script>
</body>
</html>
