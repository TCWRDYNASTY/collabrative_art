<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>The Little Dog I Miss</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* --- 1. GLOBAL SETTINGS --- */
:root {
    --frame-thickness: clamp(20px, 5vw, 60px); 
    --wall-color: #F2F1EC;
    --gold: #d4af37;
    --slate-black: #1a1a1a;
}

body {
    background-color: var(--wall-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px;
    min-height: 100vh;
    margin: 0;
    box-sizing: border-box;
}

/* --- 2. THE FRAME (Restored to your original size) --- */
.frame-wrapper {
    position: relative;
    width: 100%;
    max-width: 800px;
    background-color: #fff;
    padding: 2px;
    border: 6px solid white;
    box-shadow: 12px 12px 25px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
}

/* --- 3. THE PUZZLE GRID (Fixed Proportions) --- */
.puzzle-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    width: 100%; 
    /* This restores your original image shape */
    aspect-ratio: 3600 / 3000; 
    gap: 2px;
    background-color: #111;
    overflow: hidden;
}

.piece {
    perspective: 1000px; 
    cursor: pointer;
    position: relative;
    width: 100%;
    height: 100%; /* Removes the fixed 150px that made it too big */
}

.piece-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    transform-style: preserve-3d;
}

.piece.flipped .piece-inner {
    transform: rotateY(180deg);
}

.piece-front, .piece-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    overflow: hidden;
}

.piece-front {
    background-color: #222;
}

.piece-front img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    opacity: 0; 
    transition: opacity 1s ease;
}

.unlocked .piece-front img {
    opacity: 1; 
}

.piece-back {
    background-color: #222;
    color: var(--gold);
    transform: rotateY(180deg);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    text-align: center;
    font-family: monospace;
    border: 2px solid var(--gold);
    box-sizing: border-box;
}

.label-id {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    opacity: 0.3;
    font-size: 1.5rem;
    pointer-events: none;
}

.unlocked .label-id {
    display: none;
}

/* --- 4. THE MUSEUM PLAQUE (Description) --- */
.container {
    width: 90%;
    max-width: 320px;
    background-color: var(--slate-black); 
    border-radius: 2px;
    padding: 1.5rem;
    margin-top: 20px; 
    display: flex;
    flex-direction: column;
    align-items: center; 
    text-align: center;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--gold);
    border-top: 4px solid var(--gold);
    box-sizing: border-box;
}

h1 { color: #fdfdfb; font-size: 1.5rem; font-family: 'Times New Roman', serif; margin: 0 0 5px 0; }
h2 { color: var(--gold); font-size: 0.9rem; font-family: "Garamond", serif; font-style: italic; margin: 0; }
h3 { color: #eae6da; font-size: 1.0rem; font-family: 'Times New Roman', serif; margin: 0; }

/* --- 5. INTRO OVERLAY (Fixed Visibility) --- */
#introOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10001;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 40px;
}

#introOverlay p {
    color: white;
    font-family: sans-serif;
    max-width: 500px;
    line-height: 1.6;
    font-size: 1.2rem;
    margin-bottom: 2rem;
}

#viewartBtn {
    padding: 15px 30px;
    background-color: var(--slate-black);
    color: white;
    border: 1px solid var(--gold);
    border-radius: 50px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s;
}

.hidden {
    display: none !important;
}
</style>

</head>
    <body></body>
    <div class="puzzle-grid" id="main-puzzle">
    <div id="piece-1" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section1.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 1</strong>
                <p>Near the red brick wall where the ivy grows thick.</p>
            </div>
        </div>
    </div>

    <div id="piece-2" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section2.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 2</strong>
                <p>Under the third lamp post from the corner cafe.</p>
            </div>
        </div>
    </div>

    <div id="piece-3" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section3.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 3</strong>
                <p>Check behind the blue bench facing the fountain.</p>
            </div>
        </div>
    </div>

    <div id="piece-4" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section4.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 4</strong>
                <p>Hidden near the old oak tree's lowest branch.</p>
            </div>
        </div>
    </div>

    <div id="piece-5" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section5.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 5</strong>
                <p>Look where the stone path turns toward the garden.</p>
            </div>
        </div>
    </div>

    <div id="piece-6" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section6.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 6</strong>
                <p>By the iron gate that never stays closed.</p>
            </div>
        </div>
    </div>

    <div id="piece-7" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section7.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 7</strong>
                <p>Near the bike rack with the yellow stripes.</p>
            </div>
        </div>
    </div>

    <div id="piece-8" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section8.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 8</strong>
                <p>Tucked behind the community bulletin board.</p>
            </div>
        </div>
    </div>

    <div id="piece-9" class="piece" onclick="handleFlip(this)">
        <div class="piece-inner">
            <div class="piece-front">
                <img src="section9.png"><div class="label-id">?</div>
            </div>
            <div class="piece-back">
                <strong>PIECE 9</strong>
                <p>The final secret lies beneath the clock tower.</p>
            </div>
        </div>
    </div>
</div>
   <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
// --- CONFIGURATION ---
const REVEAL_DATE = new Date(2026, 11, 31, 23, 59);

const firebaseConfig = {
  apiKey: "AIzaSyBakPBYb0ngjOvHr89baflUet6S4d6E7Ec",
  authDomain: "called0collaborative-art.firebaseapp.com",
  projectId: "called0collaborative-art",
  storageBucket: "called0collaborative-art.firebasestorage.app",
  messagingSenderId: "63650107916",
  appId: "1:63650107916:web:c0d369519d84d21d759429",
  measurementId: "G-8GLRF54W15"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- INITIALIZATION ---

// Combined listener to hide overlay and start the logic
document.getElementById('viewartBtn')?.addEventListener('click', () => {
    document.getElementById('introOverlay').classList.add('hidden');
    init(); // Only run the puzzle logic AFTER they click the button
});

async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const pieceNum = urlParams.get('piece'); 
    const project = urlParams.get('project') || 'penny'; 

    // 1. Check if the project is finished by date
    if (new Date() > REVEAL_DATE) {
        revealAll();
    } else {
        // 2. Load all currently found pieces from the database
        await loadFoundPieces(project);
    }

    // 3. Handle a new scan if 'piece' is in the URL
    if (pieceNum) {
        handleScannedPiece(pieceNum, project);
    }
}

// --- CORE LOGIC ---

async function loadFoundPieces(project) {
    const snapshot = await db.collection("puzzles")
        .where("project_id", "==", project)
        .where("is_found", "==", true)
        .get();

    snapshot.forEach(doc => {
        const idParts = doc.id.split('-');
        const num = idParts[idParts.length - 1];
        unlockPiece(num, false);
    });
}

async function handleScannedPiece(num, project) {
    const docId = `${project}-${num}`; 
    const docRef = db.collection("puzzles").doc(docId);

    try {
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();
            if (!data.is_found) {
                // UPDATE FIREBASE
                await docRef.update({
                    is_found: true,
                    found_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                unlockPiece(num, true);
            } else {
                unlockPiece(num, false);
            }
        }
        
        // CLEAN THE URL: This stops the "Auto-Unlock" loop on refresh
        // It removes "?piece=X" from the address bar without reloading the page
        window.history.replaceState({}, document.title, window.location.pathname);

    } catch (e) {
        console.error("Firebase Sync Error:", e);
    }
}

function unlockPiece(num, isFirst) {
    if (isFirst) {
        document.querySelector('h2').innerText = "CalleDÅ: Piece Discovered!";
    }
    const pieceElement = document.getElementById(`piece-${num}`);
    if (pieceElement) {
        pieceElement.classList.add('unlocked');
    }
}

function revealAll() {
    document.querySelectorAll('.piece').forEach(p => p.classList.add('unlocked'));
    document.querySelector('h2').innerText = "The hunt has concluded. Art revealed.";
}
     function handleFlip(el) {
    // Only allow the 3D flip if the piece has the 'unlocked' class
    if (el.classList.contains('unlocked')) {
        el.classList.toggle('flipped');
    } else {
        // Optional: a little nudge for the user
        console.log("This piece hasn't been discovered yet!");
    }
}
    
</script>
</body>
</html>
