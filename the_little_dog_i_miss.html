<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <title>The Little Dog I Miss</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* --- 1. GLOBAL SETTINGS (Wall & Layout) --- */
:root {
    --frame-thickness: clamp(20px, 5vw, 60px); 
    --wall-color: #F2F1EC;
    --gold: #d4af37;
    --slate-black: #1a1a1a;
}

body {
    background-color: var(--wall-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; 
    padding: 30px 20px;
    min-height: 100vh;
    margin: 0;
    box-sizing: border-box;
}

/* --- 2. THE 3D FRAME (The Main Art) --- */
.frame-wrapper {
    position: relative;
    width: 100%;
    max-width: 800px;
    box-sizing: border-box;
    background-color: #fff;
    padding: 2px;
    border: 6px solid white;
    box-shadow: 12px 12px 25px rgba(0,0,0,0.3);
    border-radius: 2px; 
    transition: transform 0.3s ease;
}

.frame-wrapper:hover {
    transform: translate(-4px, -4px);
    box-shadow: 20px 20px 40px rgba(0,0,0,0.4);
}

/* --- 3. THE PUZZLE GRID --- */
.puzzle-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    width: 100%; 
    aspect-ratio: 3600 / 3000; 
    gap: 2px;
    background-color: #111;
    box-shadow: inset 0 10px 20px rgba(0,0,0,0.8);
    overflow: hidden;
}

/* 3D PIECE LOGIC */
.piece {
    perspective: 1000px; /* Required for 3D flip */
    cursor: pointer;
    position: relative;
}

.piece-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    transform-style: preserve-3d;
}

/* Trigger flip */
.piece.flipped .piece-inner {
    transform: rotateY(180deg);
}

.piece-front, .piece-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    border-radius: 0; 
}

.piece-front img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    opacity: 0; 
    transition: opacity 1s ease;
}

.unlocked .piece-front img {
    opacity: 1;
}

/* The Clue Side */
.piece-back {
    background-color: #222;
    color: var(--gold);
    transform: rotateY(180deg);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
    text-align: center;
    font-family: monospace;
    font-size: 0.8rem;
    border: 1px solid var(--gold);
    box-sizing: border-box;
}

.label-id {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    opacity: 0.3;
}

.unlocked .label-id {
    display: none;
}

/* --- 4. THE MUSEUM PLAQUE --- */
.container {
    width: 90%;
    max-width: 320px;
    background-color: var(--slate-black); 
    border-radius: 2px;
    padding: 1.5rem;
    margin-top: 20px; 
    display: flex;
    flex-direction: column;
    align-items: center; 
    text-align: center;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--gold);
    border-top: 4px solid var(--gold);
    box-sizing: border-box;
}

h1 { color: #fdfdfb; font-size: 1.5rem; margin: 0 0 5px 0; font-family: 'Times New Roman', serif; }
h2 { color: var(--gold); font-size: 0.9rem; font-family: "Garamond", serif; font-style: italic; margin: 0; }
h3 { color: #eae6da; font-size: 1.0rem; font-family: 'Times New Roman', serif; margin: 0; }

#introOverlay {
    position: fixed;
    inset: 0;
    background: rgba(10, 10, 10, 0.98); /* Deep charcoal, nearly opaque */
    backdrop-filter: blur(10px);        /* Blurs the art behind the text */
    z-index: 10001;
    display: flex;
    flex-direction: column;             /* Stacks P and Button vertically */
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
}

#introOverlay p {
    color: #ffffff;                    /* Pure white for maximum contrast */
    font-family: 'Times New Roman', serif; /* Matching your museum theme */
    max-width: 600px;
    line-height: 1.8;
    font-size: clamp(1.1rem, 4vw, 1.5rem); /* Responsive text size */
    margin-bottom: 3rem;               /* Space between text and button */
    opacity: 1 !important;             /* Ensures it isn't inheriting transparency */
}

/* Ensure the button is visible and styled */
#viewartBtn {
    padding: 18px 40px;
    background-color: transparent;
    color: var(--gold);
    border: 2px solid var(--gold);
    border-radius: 2px;               /* Sharp corners for the museum look */
    font-family: "Garamond", serif;
    font-size: 1.2rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
}

#viewartBtn:hover {
    background-color: var(--gold);
    color: var(--slate-black);
}

#homeBtn { align-self: flex-end; margin: 10px 20px 30px 0; padding: 12px 25px; background: white; border: 3px solid black; border-radius: 12px; font-weight: bold; cursor: pointer; }
#homeLink { align-self: flex-end; text-decoration: none; }

</style>



</head>
<body>

    <div id="introOverlay">
        <p>
            The art here is a collaborative puzzle. <br><br>
            Find the hidden pieces around the city to reveal the story of "The Little Dog I Miss."
        </p>
        <button id="viewartBtn">View the Art</button>
    </div>

    <a href="streetpuzzle.org" id="homeLink">
        <button id="homeBtn">Home</button>
    </a>

    <div class="frame-wrapper">
        <div class="puzzle-grid" id="main-puzzle">
            <div id="piece-1" class="piece"><img src="section1.png"><div class="label-id">?</div></div>
            <div id="piece-2" class="piece"><img src="section2.png"><div class="label-id">?</div></div>
            <div id="piece-3" class="piece"><img src="section3.png"><div class="label-id">?</div></div>
            <div id="piece-4" class="piece"><img src="section4.png"><div class="label-id">?</div></div>
            <div id="piece-5" class="piece"><img src="section5.png"><div class="label-id">?</div></div>
            <div id="piece-6" class="piece"><img src="section6.png"><div class="label-id">?</div></div>
            <div id="piece-7" class="piece"><img src="section7.png"><div class="label-id">?</div></div>
            <div id="piece-8" class="piece"><img src="section8.png"><div class="label-id">?</div></div>
            <div id="piece-9" class="piece"><img src="section9.png"><div class="label-id">?</div></div>
        </div>
    </div>
   
    <div class="container">
        <h1>The Little Dog I Miss</h1>
        <h2 id="status-display">Digital Media</h2>
        <h3><p>San Francisco Peninsula</p></h3>
    </div>
    <script>
        document.getElementById('viewartBtn').addEventListener('click', function() {
            document.getElementById('introOverlay').classList.add('hidden');
        });
    </script>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
// --- CONFIGURATION ---
const REVEAL_DATE = new Date(2026, 11, 31, 23, 59);

// PASTE YOUR FIREBASE CONFIG BOX HERE:
const firebaseConfig = {
  apiKey: "AIzaSyBakPBYb0ngjOvHr89baflUet6S4d6E7Ec",
  authDomain: "called0collaborative-art.firebaseapp.com",
  projectId: "called0collaborative-art",
  storageBucket: "called0collaborative-art.firebasestorage.app",
  messagingSenderId: "63650107916",
  appId: "1:63650107916:web:c0d369519d84d21d759429",
  measurementId: "G-8GLRF54W15"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- INITIALIZATION ---
document.getElementById('viewartBtn')?.addEventListener('click', () => {
    document.getElementById('introOverlay').classList.add('hidden');
});

async function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const pieceNum = urlParams.get('piece'); // e.g., "1"
    const project = urlParams.get('project') || 'penny'; // e.g., "penny"

    // 1. Check if the whole project is already revealed by date
    if (new Date() > REVEAL_DATE) {
        revealAll();
    } else {
        // 2. Load all currently found pieces for the 3x3 grid
        await loadFoundPieces(project);
    }

    // 3. If this visit is from a new QR scan, handle the unlock
    if (pieceNum) {
        handleScannedPiece(pieceNum, project);
    }
}

// --- CORE LOGIC ---

async function loadFoundPieces(project) {
    // Looks for all documents in 'puzzles' where project_id is 'penny' and is_found is true
    const snapshot = await db.collection("puzzles")
        .where("project_id", "==", project)
        .where("is_found", "==", true)
        .get();

    snapshot.forEach(doc => {
        const data = doc.data();
        // Extract the number from the ID (e.g., "penny-1" -> "1")
        const idParts = doc.id.split('-');
        const num = idParts[idParts.length - 1];
        unlockPiece(num, false);
    });
}

async function handleScannedPiece(num, project) {
    const docId = `${project}-${num}`; // Combines to "penny-1"
    const docRef = db.collection("puzzles").doc(docId);

    try {
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();
            if (!data.is_found) {
                // UPDATE FIREBASE: Set to true and add server time
                await docRef.update({
                    is_found: true,
                    found_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                unlockPiece(num, true);
            } else {
                unlockPiece(num, false);
            }
        }
    } catch (e) {
        console.error("Firebase Error:", e);
    }
}

function unlockPiece(num, isFirst) {
    if (isFirst) {
        document.querySelector('h2').innerText = "CalleDÅ: Piece Discovered!";
    }
    const pieceElement = document.getElementById(`piece-${num}`);
    if (pieceElement) pieceElement.classList.add('unlocked');
}

function revealAll() {
    document.querySelectorAll('.piece').forEach(p => p.classList.add('unlocked'));
    document.querySelector('h2').innerText = "The hunt has concluded. Art revealed.";
}

init();
</script>
</body>
</html>
